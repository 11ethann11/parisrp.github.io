<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Paris RP FR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #374151; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
    </style>
</head>
<body class="antialiased">

    <!-- Écran de Connexion (visible par défaut) -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
            <div class="text-center mb-8">
                <img src="https://i.ibb.co/QnCgmnS/Paris-RP-FR.png" alt="Logo" class="w-20 h-20 mx-auto rounded-full mb-4 border-2 border-indigo-500" />
                <h1 class="text-2xl font-bold">Administration</h1>
                <p class="text-gray-400">Paris RP FR</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email-input" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input id="email-input" type="email" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-white" required>
                </div>
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-300 mb-1">Mot de passe</label>
                    <input id="password-input" type="password" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-white" required>
                </div>
                <p id="auth-error" class="text-red-400 text-sm text-center h-4"></p>
                <button type="submit" id="login-submit-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-md transition">Se Connecter</button>
            </form>
        </div>
    </div>

    <!-- Panneau d'Administration (caché par défaut) -->
    <div id="admin-panel" class="hidden">
        <header class="bg-gray-800/80 backdrop-blur-md border-b border-gray-700 sticky top-0 z-10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20">
                <h1 class="text-xl font-bold">Panneau d'Administration</h1>
                <div>
                    <span id="save-status" class="text-sm mr-4 text-green-400 transition-opacity duration-300"></span>
                    <button id="save-changes-btn" class="btn-primary font-bold py-2 px-5 rounded-md transition">Sauvegarder</button>
                    <button id="logout-btn" class="ml-4 btn-secondary font-bold py-2 px-5 rounded-md transition">Déconnexion</button>
                </div>
            </div>
        </header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="admin-form-container" class="space-y-8">
                <p id="loading-message" class="text-center text-gray-400">Chargement des données...</p>
            </div>
        </main>
    </div>

    <script type="module">
        // Import des modules Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        // Votre configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCHxZvMq227zpskRJi4oCANh1T1Yq3MAjU",
            authDomain: "parisrpfr-roblox.firebaseapp.com",
            projectId: "parisrpfr-roblox",
            storageBucket: "parisrpfr-roblox.firebasestorage.app",
            messagingSenderId: "282300950781",
            appId: "1:282300950781:web:0a3d9eeeb58563dbe43694",
        };

        // Initialisation de Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Références aux éléments du DOM
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const adminFormContainer = document.getElementById('admin-form-container');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        const saveStatus = document.getElementById('save-status');
        const loadingMessage = document.getElementById('loading-message');

        const contentRef = doc(db, "websiteContent", "mainPage");

        // Structure du formulaire
        const formStructure = [
            { group: 'Général', fields: [
                { key: 'site_title', label: 'Titre Global du Site', type: 'text' },
                { key: 'site_subtitle', label: 'Sous-titre Global du Site', type: 'text' },
            ]},
            { group: 'Accueil', fields: [
                { key: 'home_title', label: "Titre d'Accueil", type: 'text' },
                { key: 'home_subtitle', label: "Paragraphe d'Accueil", type: 'textarea' },
                { key: 'community_section_title', label: "Titre Section 'Pourquoi Notre Communauté'", type: 'text' },
                { key: 'card1_title', label: 'Titre Carte 1', type: 'text' }, { key: 'card1_text', label: 'Texte Carte 1', type: 'textarea' },
                { key: 'card2_title', label: 'Titre Carte 2', type: 'text' }, { key: 'card2_text', label: 'Texte Carte 2', type: 'textarea' },
                { key: 'card3_title', label: 'Titre Carte 3', type: 'text' }, { key: 'card3_text', label: 'Texte Carte 3', type: 'textarea' },
            ]},
            { group: 'À Propos', fields: [
                { key: 'about_title', label: "Titre de la section 'À Propos'", type: 'text' },
                { key: 'about_content', label: "Contenu de 'À Propos' (HTML permis)", type: 'textarea' },
            ]},
            { group: 'Règlement', fields: [
                { key: 'rules_title', label: "Titre de la section 'Règlement'", type: 'text' },
                { key: 'rules_content', label: "Contenu de 'Règlement' (HTML permis)", type: 'textarea' },
            ]},
            { group: 'Rejoindre', fields: [
                { key: 'join_title', label: "Titre de la section 'Rejoindre'", type: 'text' },
                { key: 'join_content', label: "Contenu de 'Rejoindre' (HTML permis)", type: 'textarea' },
            ]},
            { group: 'Contact', fields: [
                { key: 'contact_title', label: "Titre de la section 'Contact'", type: 'text' },
                { key: 'contact_content', label: "Contenu de 'Contact' (HTML permis)", type: 'textarea' },
            ]},
            { group: 'Pied de Page', fields: [
                { key: 'footer_copyright', label: 'Texte du Copyright', type: 'text' },
                { key: 'footer_disclaimer', label: 'Texte de non-responsabilité', type: 'text' },
            ]}
        ];

        // Fonction pour construire le formulaire
        function buildForm(data) {
            adminFormContainer.innerHTML = ''; // Vide le conteneur

            formStructure.forEach(group => {
                const groupContainer = document.createElement('div');
                groupContainer.className = 'bg-gray-900/50 p-6 rounded-lg';
                
                const groupTitle = document.createElement('h3');
                groupTitle.className = 'text-xl font-bold mb-4 text-indigo-400 border-b border-gray-700 pb-2';
                groupTitle.textContent = group.group;
                groupContainer.appendChild(groupTitle);
                
                const fieldsContainer = document.createElement('div');
                fieldsContainer.className = 'space-y-4';
                
                group.fields.forEach(({ key, label, type }) => {
                    const value = data[key] || '';
                    const fieldWrapper = document.createElement('div');
                    
                    const labelEl = document.createElement('label');
                    labelEl.className = "block text-sm font-semibold text-gray-300 mb-1";
                    labelEl.textContent = label;
                    fieldWrapper.appendChild(labelEl);

                    let inputEl;
                    if (type === 'textarea') {
                        inputEl = document.createElement('textarea');
                        inputEl.rows = 5;
                        inputEl.textContent = value;
                    } else {
                        inputEl = document.createElement('input');
                        inputEl.type = 'text';
                        inputEl.value = value;
                    }
                    inputEl.className = "admin-input w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white";
                    inputEl.dataset.key = key;
                    fieldWrapper.appendChild(inputEl);
                    fieldsContainer.appendChild(fieldWrapper);
                });

                groupContainer.appendChild(fieldsContainer);
                adminFormContainer.appendChild(groupContainer);
            });
        }

        // Fonction principale pour charger les données
        async function loadAdminData() {
            loadingMessage.textContent = 'Chargement des données...';
            try {
                const docSnap = await getDoc(contentRef);
                const data = docSnap.exists() ? docSnap.data() : {};
                buildForm(data);
            } catch (error) {
                console.error("Erreur de chargement Firestore:", error);
                loadingMessage.textContent = "Erreur de chargement. Vérifiez vos règles de sécurité Firebase et actualisez la page.";
                loadingMessage.classList.add('text-red-500');
            }
        }

        // Gestion de l'état de connexion de l'utilisateur
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadAdminData(); // Charge les données après connexion
            } else {
                loginScreen.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }
        });

        // Connexion
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authError.textContent = 'Email ou mot de passe incorrect.';
            }
        });

        // Déconnexion
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // Sauvegarde des modifications
        saveChangesBtn.addEventListener('click', async () => {
            saveStatus.textContent = "Sauvegarde en cours...";
            saveStatus.classList.remove('text-red-400');
            saveStatus.classList.add('text-green-400');

            const dataToSave = {};
            document.querySelectorAll('.admin-input').forEach(input => {
                dataToSave[input.dataset.key] = input.value;
            });

            try {
                await setDoc(contentRef, dataToSave);
                saveStatus.textContent = "Modifications sauvegardées !";
            } catch (error) {
                saveStatus.textContent = "Erreur de sauvegarde.";
                saveStatus.classList.remove('text-green-400');
                saveStatus.classList.add('text-red-400');
                console.error(error);
            } finally {
                setTimeout(() => { saveStatus.textContent = "" }, 3000);
            }
        });
    </script>
</body>
</html>
